import{d as Ce,E as Ne,r as M,b as h,U as Ae,e as Ie,o as qe,M as Me,i as $e,y,A as o,D as v,u as w,F as j,K as L,x as O,C as $,I as ne,z as m}from"./vue-vendor-DSdsonjH.js";import{g as Fe,c as Re,C as Ee}from"./index-BzoJvuOE.js";import{_ as ae}from"./RichTextView.vue_vue_type_script_setup_true_lang-CMYdHiiQ.js";import"./ui-BLgiSNLv.js";const Oe=()=>new Date().toISOString(),G=e=>`preview-state:${e}`,z=()=>typeof window<"u"&&window.localStorage?window.localStorage:null,C=e=>e.type==="question",Be=e=>{const t=[];return e.forEach((a,u)=>{a.steps.forEach((c,i)=>{t.push({section:a,step:c,sectionIndex:u,stepIndex:i,globalIndex:t.length})})}),t},je=(e,t)=>e.length===t.length&&e.every(a=>t.includes(a)),Le=(e,t)=>{if(e.inputRule.type==="single"){const a=e.inputRule.correctOptions[0];return t.length===1&&t[0]===a?1:0}return je([...t].sort(),[...e.inputRule.correctOptions].sort())?1:0},D=(e,t,a)=>({steps:e.steps.map((c,i)=>i===t?a(c):c),position:e.position}),le=e=>({steps:Be(e.structure),position:0}),F=e=>e.steps[e.position]??null,R=e=>!!e.answer?.submittedAt,De=e=>{const t=F(e);return!t||!C(t.step)||R(t)?!1:(t.answer?.selected??[]).length>0},Ve=e=>{const t=F(e);if(!t||!C(t.step)||R(t))return e;const a=t.answer?.selected??[],u=Le(t.step,a),c={selected:[...a],score:u,submittedAt:Oe()};return D(e,e.position,i=>({...i,answer:c}))},Qe=(e,t)=>{const a=F(e);if(!a||!C(a.step)||R(a))return e;const u={selected:[t],score:0,submittedAt:""};return D(e,e.position,c=>({...c,answer:u}))},Te=(e,t)=>{const a=F(e);if(!a||!C(a.step)||R(a)||a.step.inputRule.type!=="multiple")return e;const c={selected:Array.from(new Set((t??[]).filter(i=>Number.isFinite(i)).map(i=>Number(i)))).sort((i,p)=>i-p),score:0,submittedAt:""};return D(e,e.position,i=>({...i,answer:c}))},ue=e=>e.position>0,ie=e=>{if(e.position>=e.steps.length-1)return!1;const t=F(e);return t?C(t.step)?R(t):!0:!1},Ge=e=>ue(e)?{...e,position:e.position-1}:e,ze=e=>ie(e)?{...e,position:e.position+1}:e,Ue=(e,t)=>{const a=Math.max(0,Math.min(t,e.steps.length-1));return{...e,position:a}},Ke=e=>{const t=new Map;e.steps.forEach(p=>{if(t.has(p.section.id)||t.set(p.section.id,{section:p.section,questions:0,correct:0}),C(p.step)){const _=t.get(p.section.id);_.questions+=1,_.correct+=p.answer?.score===1?1:0}});const a=[...t.values()].map(p=>({...p,accuracy:p.questions===0?0:p.correct/p.questions})),u=a.reduce((p,_)=>p+_.questions,0),c=a.reduce((p,_)=>p+_.correct,0),i=u===0?0:c/u;return{totalQuestions:u,totalCorrect:c,totalAccuracy:i,bySection:a}},Je=(e,t)=>{if(!t)return e;const a=new Map(e.steps.map((c,i)=>[c.step.id,i]));t.answers.forEach(c=>{const i=a.get(c.stepId);if(i==null)return;const p=e.steps[i];if(!p||!C(p.step))return;const _=Array.isArray(c.selected)?c.selected.filter(f=>Number.isFinite(f)).map(f=>Number(f)):[],N={selected:p.step.inputRule.type==="multiple"?Array.from(new Set(_)).sort((f,k)=>f-k):_.slice(0,1),score:Number.isFinite(c.score)?c.score:0,submittedAt:typeof c.submittedAt=="string"?c.submittedAt:""};e=D(e,i,f=>({...f,answer:N}))});const u=Math.max(0,Math.min(t.position??0,e.steps.length-1));return{...e,position:u}},We=e=>{const t=le(e),a=z();if(!a)return t;const u=a.getItem(G(e.id));if(!u)return t;try{const c=JSON.parse(u);return Je(t,c)}catch{return t}},He=(e,t)=>{const a=z();if(!a)return;const u=t.steps.filter(i=>C(i.step)&&i.answer).map(i=>({stepId:i.step.id,selected:[...i.answer?.selected??[]],score:i.answer?.score??0,submittedAt:i.answer?.submittedAt??""})),c={position:t.position,answers:u};a.setItem(G(e),JSON.stringify(c))},Xe=e=>{const t=z();t&&t.removeItem(G(e))},Ye={class:"flex flex-col bg-white"},Ze={class:"border-b border-gray-200 px-4 py-2 flex items-center justify-between shrink-0"},et={class:"text-sm font-medium truncate"},tt={class:"flex items-center gap-3 shrink-0 ml-4"},st={class:"text-xs text-gray-600"},rt={class:"flex flex-1 overflow-hidden"},ot={class:"w-60 border-r border-gray-200 overflow-y-auto shrink-0"},nt={class:"p-2 space-y-3"},at={class:"px-2 text-xs font-semibold text-gray-700 flex items-center justify-between"},lt={class:"truncate"},ut={class:"text-[10px] text-gray-500 shrink-0 ml-2"},it={class:"space-y-0.5"},ct=["onClick"],dt={class:"truncate block"},pt={class:"pt-3 mt-3 border-t border-gray-100"},vt={class:"flex-1 overflow-y-auto p-6"},ft={key:0,class:"max-w-3xl mx-auto"},bt={class:"border border-gray-200 rounded-lg bg-gray-50 p-5"},gt={class:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"},yt={class:"text-base font-semibold text-gray-900"},mt={class:"text-sm text-gray-600"},ht={class:"text-sm font-semibold text-gray-900"},xt={class:"mt-4 grid gap-3 md:grid-cols-2"},_t={class:"text-sm font-medium text-gray-900"},wt={class:"text-xs text-gray-500"},kt={class:"text-sm font-semibold text-gray-900"},St={class:"mt-6 flex justify-end"},Pt={key:1,class:"max-w-3xl mx-auto"},Ct={key:0,class:"space-y-4"},Nt={key:0,class:"text-lg font-semibold text-gray-900"},At={key:1,class:"space-y-4"},It={key:0,class:"text-lg font-semibold text-gray-900"},qt={class:"text-xs font-semibold text-gray-600"},Mt={class:"mt-4 space-y-2"},$t=["disabled","onClick"],Ft={class:"flex items-center gap-3"},Rt={class:"text-sm text-gray-900 flex-1"},Et={key:0,class:"text-green-600 shrink-0","aria-label":"Correct answer"},Ot={key:1,class:"mt-4 flex justify-end"},Bt=["disabled"],jt={class:"text-sm font-medium"},Lt={class:"border-t border-gray-200 px-4 py-3 flex items-center justify-between shrink-0 bg-gray-50"},Dt={class:"flex items-center gap-3"},Vt=["disabled"],Qt={class:"text-xs text-gray-600"},Tt=["disabled"],Jt=Ce({__name:"CoursePreviewPage",setup(e){const t=Me(),a=Ae(),{t:u}=Ne(),c=Ee,i=M(""),p=M(null),_=M([]),r=M(null),N=M(0),f=M(!1),k=()=>{!p.value||!r.value||He(p.value.id,r.value)},ce=n=>{if(!n)return 0;const d=n.steps.reduce((s,b)=>b.answer?Math.max(s,b.globalIndex):s,-1);return Math.max(0,d,n.position)},l=h(()=>r.value?F(r.value):null),U=h(()=>r.value?.position??0),de=h(()=>r.value?.steps.length??0),pe=h(()=>l.value?.step.type==="slide"),S=h(()=>l.value?R(l.value):!1),K=h(()=>r.value?ue(r.value):!1),J=h(()=>r.value?ie(r.value):!1),W=h(()=>r.value?De(r.value):!1),ve=h(()=>!r.value||r.value.steps.length===0?!1:r.value.position===r.value.steps.length-1),E=h(()=>!r.value||!r.value.steps.some(d=>d.step.type==="question")?!1:r.value.steps.every(d=>d.step.type!=="question"||!!d.answer?.submittedAt)),H=h(()=>E.value&&ve.value&&!f.value),q=h(()=>!E.value||!r.value?null:Ke(r.value)),X=h(()=>f.value?u("coursePreview.finalReportLabel"):u("coursePreview.progress",{current:(U.value??0)+1,total:de.value??0})),V=n=>`${Math.round((n??0)*100)}%`,fe=h(()=>{const n=a.params.path||"";return n.endsWith("/")?`/${n}`:`/${n}/`}),be=()=>{t.push({path:`/course${fe.value}`})};Ie(U,n=>{N.value=Math.max(N.value,n)});const Y=n=>n<=N.value,Z=(n,d)=>r.value?r.value.steps.findIndex(s=>s.section.id===n&&s.stepIndex===d):-1,ge=()=>!l.value||l.value.step.type!=="question"?u("coursePreview.instructionDefault"):l.value.step.inputRule.type==="single"?u("coursePreview.instructionSingle"):u("coursePreview.instructionMultiple"),ye=(n,d,s)=>{if(!l.value)return"text-gray-600 hover:bg-gray-50";const b=l.value.section.id===n&&l.value.step.id===d,g=Y(s);return f.value?g?"text-gray-700 hover:bg-gray-50":"text-gray-400 opacity-60 cursor-not-allowed":b?"bg-blue-50 text-blue-700 font-medium":g?"text-gray-700 hover:bg-gray-50":"text-gray-400 opacity-60 cursor-not-allowed"},me=(n,d)=>{if(!r.value)return;f.value=!1;const s=Z(n,d);s<0||!Y(s)||(r.value=Ue(r.value,s),k())},ee=n=>{if(!r.value||!l.value||S.value||l.value.step.type!=="question")return;let d=null;if(l.value.step.inputRule.type==="single")d=Qe(r.value,n);else{const s=new Set(l.value.answer?.selected??[]);s.has(n)?s.delete(n):s.add(n),d=Te(r.value,[...s])}d&&(r.value=d,k())},he=n=>{if(!l.value||l.value.step.type!=="question")return"border-gray-200 hover:border-gray-300";const s=(l.value.answer?.selected??[]).includes(n),b=S.value,g=Q(n);return b?s&&g?"border-green-500 bg-green-50":s&&!g?"border-red-500 bg-red-50":!s&&g?"border-green-200 bg-green-50/30":"border-gray-200 bg-gray-50":s?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"},xe=n=>{if(!l.value||l.value.step.type!=="question")return"w-6 h-6 rounded-full border bg-gray-100 text-gray-600 border-transparent";const{step:d}=l.value,b=d.inputRule.type==="multiple"?"w-6 h-6 rounded-md border":"w-6 h-6 rounded-full border",g=(B,T,Pe)=>`${b} ${B} ${T} ${Pe}`,A=(l.value.answer?.selected??[]).includes(n),x=S.value,I=Q(n);return x?A&&I?g("bg-green-600","text-white","border-green-600"):A&&!I?g("bg-red-600","text-white","border-red-600"):!A&&I?g("bg-green-50","text-green-800","border-green-200"):g("bg-gray-200","text-gray-600","border-gray-200"):A?g("bg-blue-600","text-white","border-blue-600"):g("bg-gray-100","text-gray-600","border-transparent")},Q=n=>!l.value||l.value.step.type!=="question"?!1:l.value.step.inputRule.correctOptions.includes(n),_e=()=>l.value?.answer?l.value.answer.score===1?"bg-green-50 text-green-800":"bg-red-50 text-red-800":"bg-gray-100",te=()=>{!r.value||!K.value||(f.value=!1,r.value=Ge(r.value),k())},se=()=>{if(r.value){if(H.value){f.value=!0;return}J.value&&(f.value=!1,r.value=ze(r.value),k())}},re=()=>{!r.value||!W.value||(f.value=!1,r.value=Ve(r.value),k())},we=()=>{E.value&&(f.value=!0)},ke=()=>E.value?f.value?"px-2 py-1 text-xs rounded bg-blue-50 text-blue-700 font-medium":"px-2 py-1 text-xs rounded text-gray-700 hover:bg-gray-50 cursor-pointer":"px-2 py-1 text-xs rounded text-gray-400 opacity-60 cursor-not-allowed",Se=()=>{p.value&&(Xe(p.value.id),r.value=le(p.value),N.value=0,f.value=!1,k())},oe=n=>{if(f.value||!l.value)return;if(n.key==="Enter"){n.preventDefault(),!pe.value&&!S.value?re():se();return}if(n.key==="Escape"){n.preventDefault(),te();return}const d=Number(n.key);if(d>=1&&d<=9&&l.value.step.type==="question"){const s=d-1;s<l.value.step.options.length&&ee(s)}};return qe(async()=>{const n=await Fe(c),d=a.params.path||"",s=d.endsWith("/")?`/${d}`:`/${d}/`,g=(x=>{const I=x.split("/").filter(Boolean).map(T=>Number(T)).filter(Number.isFinite),B=I.length>0?I[I.length-1]:void 0;return B??null})(s),P=g!=null?n.find(x=>x.id===g&&x.deletedAt===null):null;if(!P||P.type!=="leaf"){t.push({path:"/"});return}i.value=P.name;const A=typeof P.objectId=="string"?P.objectId:null;if(A){const x=Re(A);if(x&&x.deletedAt===null)p.value=x,i.value=x.fullName||P.name,_.value=x.structure||[],r.value=We(x),N.value=ce(r.value),f.value=E.value,k();else{t.push({path:`/course${s}`});return}}else{t.push({path:`/course${s}`});return}window.addEventListener("keydown",oe)}),$e(()=>{window.removeEventListener("keydown",oe)}),(n,d)=>(m(),y("div",Ye,[o("header",Ze,[o("h1",et,v(i.value),1),o("div",tt,[o("span",st,v(X.value),1),o("button",{type:"button",class:"px-3 py-1.5 text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50",onClick:be},v(w(u)("coursePreview.backToCourse")),1)])]),o("div",rt,[o("aside",ot,[o("nav",nt,[(m(!0),y(j,null,L(_.value,s=>(m(),y("div",{key:s.id,class:"space-y-1"},[o("div",at,[o("span",lt,v(s.name),1),o("span",ut,v(s.steps.length),1)]),o("ul",it,[(m(!0),y(j,null,L(s.steps,(b,g)=>(m(),y("li",{key:b.id,class:O(["px-2 py-1 text-xs rounded cursor-pointer transition-colors",ye(s.id,b.id,Z(s.id,g))]),onClick:P=>me(s.id,g)},[o("span",dt,v(b.name||w(u)(b.type==="slide"?"coursePreview.slideFallback":"coursePreview.questionFallback")),1)],10,ct))),128))])]))),128)),o("div",pt,[o("div",{class:O(["transition-colors",ke()]),onClick:we},v(w(u)("coursePreview.finalReportNav")),3)])])]),o("main",vt,[f.value&&q.value?(m(),y("div",ft,[o("div",bt,[o("div",gt,[o("div",null,[o("h2",yt,v(w(u)("coursePreview.finalReportHeading")),1),o("p",mt,v(w(u)("coursePreview.finalReportSummary",{correct:q.value.totalCorrect,total:q.value.totalQuestions,accuracy:V(q.value.totalAccuracy)})),1)]),o("span",ht,v(V(q.value.totalAccuracy)),1)]),o("div",xt,[(m(!0),y(j,null,L(q.value.bySection,s=>(m(),y("div",{key:s.section.id,class:"rounded-lg border border-gray-200 bg-white p-4 flex items-center justify-between"},[o("div",null,[o("p",_t,v(s.section.name),1),o("p",wt,v(w(u)("coursePreview.sectionCorrectSummary",{correct:s.correct,total:s.questions})),1)]),o("span",kt,v(V(s.accuracy)),1)]))),128))]),o("div",St,[o("button",{type:"button",class:"px-4 py-2 text-sm font-medium text-blue-600 border border-blue-200 rounded-md hover:bg-blue-50",onClick:Se},v(w(u)("coursePreview.tryAgainButton")),1)])])])):l.value?(m(),y("div",Pt,[l.value.step.type==="slide"?(m(),y("div",Ct,[l.value.step.name?(m(),y("h2",Nt,v(l.value.step.name),1)):$("",!0),ne(ae,{content:l.value.step.content},null,8,["content"])])):(m(),y("div",At,[l.value.step.name?(m(),y("h2",It,v(l.value.step.name),1)):$("",!0),ne(ae,{content:l.value.step.slide},null,8,["content"]),o("p",qt,v(ge()),1),o("ul",Mt,[(m(!0),y(j,null,L(l.value.step.options,(s,b)=>(m(),y("li",{key:b},[o("button",{type:"button",class:O(["w-full text-left px-4 py-3 rounded-lg border-2 transition-all",he(b)]),disabled:S.value,onClick:g=>ee(b)},[o("div",Ft,[o("span",{class:O(["inline-flex items-center justify-center text-xs font-semibold shrink-0 transition-colors",xe(b)])},v(b+1),3),o("span",Rt,v(s),1),S.value&&Q(b)?(m(),y("span",Et," âœ“ ")):$("",!0)])],10,$t)]))),128))]),S.value?$("",!0):(m(),y("div",Ot,[o("button",{type:"button",class:"px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!W.value,onClick:re},v(w(u)("coursePreview.submitButton")),9,Bt)])),S.value?(m(),y("div",{key:2,class:O(["mt-4 p-3 rounded-lg",_e()])},[o("span",jt,v(l.value.answer?.score===1?w(u)("coursePreview.feedbackCorrect"):w(u)("coursePreview.feedbackIncorrect")),1)],2)):$("",!0)]))])):$("",!0)])]),o("footer",Lt,[o("div",Dt,[o("button",{type:"button",class:"px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!K.value,onClick:te},v(w(u)("coursePreview.backButton")),9,Vt),o("span",Qt,v(X.value),1)]),o("div",null,[o("button",{type:"button",class:"px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:f.value||!J.value&&!H.value,onClick:se},v(w(u)("coursePreview.nextButton")),9,Tt)])])]))}});export{Jt as default};
