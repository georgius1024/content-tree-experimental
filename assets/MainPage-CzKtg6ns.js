import{d as A,r as w,e as O,G as _,u as l,H as j,y as b,K as Q,S as $,B as X,F as Y,z as m,A as h,D,E as M,C as V,I as P,x as S,b as L,o as Z,M as ee}from"./vue-vendor-DSdsonjH.js";import{_ as te}from"./TreeBreadcrumb.vue_vue_type_script_setup_true_lang-Dgi872bb.js";import{V as ne}from"./vue-draggable-next.esm-bundler-DB3MgKZV.js";import{F as R,c as W,G as ae,P as oe,T as se}from"./ui-BLgiSNLv.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{s as le,C as ie,g as B,m as E,a as de,d as ce}from"./index-D7UIgnPN.js";const ue=["onClick","onDragover","onDrop"],pe={class:"px-2 py-1 text-sm inline-flex items-center gap-2"},me=A({__name:"TreeList",props:{items:{},parentId:{},forestId:{},handleClass:{default:".drag-handle"}},emits:["drop-node","click","drop-into"],setup(i,{emit:u}){const c=i,s=u,a=w([]),o=w(null);O(()=>c.items,n=>{a.value=Array.isArray(n)?[...n]:[]},{immediate:!0});const y=n=>{const f=n.oldIndex;if(f==null){o.value=null;return}const d=a.value[f];o.value=d?d.id:null},v=n=>{if(!n.moved){a.value=[...c.items];return}const{oldIndex:f,newIndex:d}=n.moved,C=c.items[f];if(!C){a.value=[...c.items];return}s("drop-node",{nodeId:C.id,newParentId:c.parentId,newPosition:d}),a.value=[...c.items]},x=n=>{s("click",{itemId:n})},r=n=>{},F=n=>{o.value!=null&&n.type!=="leaf"&&(s("drop-into",{nodeId:o.value,targetParentId:n.id}),a.value=[...c.items],o.value=null)};return(n,f)=>(m(),_(l(ne),{modelValue:a.value,"onUpdate:modelValue":f[0]||(f[0]=d=>a.value=d),"item-key":"id",tag:"ul",class:"flex flex-col gap-1",animation:200,"swap-threshold":.5,"chosen-class":"opacity-60","ghost-class":"drag-ghost",handle:c.handleClass,onStart:y,onChange:v},{default:j(()=>[(m(!0),b(Y,null,Q(a.value,(d,C)=>(m(),b("li",{key:d.id,class:"rounded hover:bg-gray-50 cursor-pointer",onClick:N=>x(d.id),onDragover:$(N=>r(d),["prevent"]),onDrop:$(N=>F(d),["stop","prevent"])},[X(n.$slots,"item",{item:d,index:C},()=>[h("div",pe,[d.type!=="leaf"?(m(),_(l(R),{key:0,size:16,class:"text-gray-500","aria-hidden":"true"})):(m(),_(l(W),{key:1,size:16,class:"text-gray-500","aria-hidden":"true"})),h("span",null,D(d.name),1)])],!0)],40,ue))),128))]),_:3},8,["modelValue","handle"]))}}),fe=re(me,[["__scopeId","data-v-41a105fb"]]),he={class:"flex items-center justify-between"},ge={class:"inline-flex items-center gap-2 flex-1 min-w-0"},ye=["title"],ve={key:0,class:"inline-flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity shrink-0"},Ie=["aria-label"],be=["aria-label"],xe=A({__name:"ContentListItem",props:{item:{},index:{},readonly:{type:Boolean}},emits:["edit","delete"],setup(i,{emit:u}){const{t:c}=M(),s=u,a=()=>{s("edit")},o=()=>{s("delete")};return(y,v)=>(m(),b("button",{type:"button",class:S(["px-2 py-1 text-sm text-left w-full rounded transition hover:bg-gray-50 group",i.item.type!=="leaf"?"cursor-pointer":""])},[h("div",he,[h("span",ge,[i.readonly?V("",!0):(m(),b("button",{key:0,type:"button",class:"drag-handle shrink-0 opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-gray-600 cursor-move",title:l(c)("common.drag"),onClick:v[0]||(v[0]=$(()=>{},["stop"]))},[P(l(ae),{size:16})],8,ye)),i.item.type!=="leaf"?(m(),_(l(R),{key:1,size:16,class:"text-gray-500 shrink-0","aria-hidden":"true"})):(m(),_(l(W),{key:2,size:16,class:"text-gray-500 shrink-0","aria-hidden":"true"})),h("span",{class:S(["truncate",i.item.type!=="leaf"?"group-hover:underline":""])},D(i.item.name),3)]),i.readonly?V("",!0):(m(),b("span",ve,[h("button",{type:"button",class:"rounded p-1 hover:bg-gray-100","aria-label":l(c)("common.edit"),onClick:$(a,["stop"])},[P(l(oe),{size:14,class:"text-gray-500","aria-hidden":"true"})],8,Ie),h("button",{type:"button",class:"rounded p-1 hover:bg-gray-100","aria-label":l(c)("common.delete"),onClick:$(o,["stop"])},[P(l(se),{size:14,class:"text-gray-500","aria-hidden":"true"})],8,be)]))])],2))}}),ke=A({__name:"ContentList",props:{items:{},parentId:{},forestId:{},readonly:{type:Boolean,default:!1},class:{},handleClass:{default:".drag-handle"}},emits:["drop-node","click","drop-into","edit","delete"],setup(i,{emit:u}){const c=i,s=u,a=r=>{s("drop-node",r)},o=r=>{s("click",r)},y=r=>{s("drop-into",r)},v=r=>{s("edit",{itemId:r.id})},x=r=>{s("delete",{itemId:r.id})};return(r,F)=>(m(),_(fe,{items:i.items,"parent-id":i.parentId,"forest-id":i.forestId,class:S(i.class),"handle-class":i.handleClass,onDropNode:a,onClick:o,onDropInto:y},{item:j(({item:n,index:f})=>[P(xe,{item:n,index:f,readonly:c.readonly,onEdit:d=>v(n),onDelete:d=>x(n)},null,8,["item","index","readonly","onEdit","onDelete"])]),_:1},8,["items","parent-id","forest-id","class","handle-class"]))}}),_e={class:"rounded-lg border border-gray-200 bg-white shadow-sm"},Ce={class:"px-4 py-2 border-b border-gray-200"},we=["onClick"],De={class:"py-2"},$e={key:0,class:"flex items-center justify-center py-8 text-gray-500 text-sm"},Pe={key:2,class:"px-2 pt-2 flex gap-2 border-t border-gray-100"},Fe=["title"],Ne=["disabled","title"],Se=A({__name:"MainPage",props:{path:{}},setup(i){const{t:u}=M(),c=i,s=ee(),a=ie,o=w(!1),y=w([]),v=w(0),x=w(null),r=L(()=>{const e=c.path.split("/").filter(Boolean).map(t=>Number(t)).filter(t=>Number.isFinite(t));return e.length===0?null:e[e.length-1]??null}),F=L(()=>(v.value,y.value.filter(e=>e.deletedAt===null).filter(e=>(e.parentId??null)===(r.value??null)).sort(le))),n=async()=>{o.value=!0;try{y.value=await B(a),v.value++}finally{o.value=!1}};Z(()=>{n()}),O(()=>c.path,()=>{n()});const f=e=>{console.log("goTo",e,s.currentRoute.value.path);const t=e.endsWith("/")?e:`${e}/`;s.push({path:t})},d=async e=>{if(console.log("onDropNode",e),r.value!=null){o.value=!0;try{await E(a,e.nodeId,e.newParentId,e.newPosition),await n()}finally{o.value=!1}}},C=async e=>{if(x.value!=null){o.value=!0;try{await E(a,x.value,e.newParentId,e.newPosition),x.value=null,await n()}finally{o.value=!1}}},N=async e=>{if(e.nodeId!==e.targetParentId){o.value=!0;try{const t=await B(a),p=t.find(g=>g.id===e.nodeId&&g.deletedAt===null);if(!p)return;const k=t.find(g=>g.id===e.targetParentId&&g.deletedAt===null);if(k&&k.path.startsWith(p.path))return;const T=t.filter(g=>g.deletedAt===null).filter(g=>(g.parentId??null)===e.targetParentId).length;await E(a,e.nodeId,e.targetParentId,T),await n()}finally{o.value=!1}}},G=e=>{const t=y.value.find(p=>p.id===e.itemId&&p.deletedAt===null);if(t){if(t.type!=="leaf"){f(t.path);return}s.push({path:`/course${t.path}`})}},q=e=>{const t=y.value.find(p=>p.id===e.itemId&&p.deletedAt===null);if(t){if(t.type==="leaf"){s.push({path:`/course${t.path}edit`});return}s.push({path:`/folder${t.path}`})}},K=async e=>{const t=e.itemId,p=await B(a),k=p.find(z=>z.id===t&&z.deletedAt===null);if(!k)return;const T=k.type==="leaf"?u("mainPage.deleteConfirm"):u("mainPage.deleteFolderConfirm");if(window.confirm(T)){o.value=!0;try{const J=p.filter(I=>I.deletedAt===null).filter(I=>I.path.startsWith(k.path)).filter(I=>I.type==="leaf"&&typeof I.objectId=="string"&&I.objectId);await Promise.all(J.map(I=>de(I.objectId))),await ce(a,t),await n()}finally{o.value=!1}}},H=()=>{const e=r.value,t=e!=null?{parentId:e.toString()}:{};s.push({path:"/folder/new",query:t})},U=()=>{const e=r.value;if(e==null){alert(u("mainPage.selectFolderFirst"));return}s.push({path:"/course/new",query:{parentId:e.toString()}})};return(e,t)=>(m(),b("div",_e,[h("div",Ce,[P(te,{"forest-id":l(a),path:i.path,onRootClick:t[0]||(t[0]=p=>f("/")),onBreadcrumbDrop:C},{item:j(({item:p})=>[h("button",{class:"truncate max-w-40 inline-block align-middle hover:underline",onClick:k=>f(p.path)},D(p.name),9,we)]),_:1},8,["forest-id","path"])]),h("div",De,[o.value?(m(),b("div",$e,D(l(u)("mainPage.loading")),1)):(m(),_(ke,{key:1,items:F.value,"parent-id":r.value,"forest-id":l(a),class:"px-2",onDropNode:d,onClick:G,onEdit:q,onDelete:K,onDropInto:N},null,8,["items","parent-id","forest-id"])),o.value?V("",!0):(m(),b("div",Pe,[h("button",{type:"button",class:"px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50",onClick:H,title:l(u)("mainPage.addSubFolderTitle")},D(l(u)("mainPage.addFolder")),9,Fe),h("button",{type:"button",class:"px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",disabled:r.value==null,onClick:U,title:r.value==null?l(u)("mainPage.selectFolderFirst"):l(u)("mainPage.addCourseTitle")},D(l(u)("mainPage.addCourse")),9,Ne)]))])]))}});export{Se as default};
