import{d as Se,E as Pe,r as M,b as x,e as Ce,o as Ne,U as Ae,M as Ie,i as qe,y,A as n,D as f,F as j,K as L,x as O,u as w,C as F,I as oe,z as m}from"./vue-vendor-DSdsonjH.js";import{g as Me,c as Fe,C as Re}from"./index-fv_kvGrx.js";import{_ as le}from"./RichTextView.vue_vue_type_script_setup_true_lang-CMYdHiiQ.js";import"./ui-BLgiSNLv.js";const $e=()=>new Date().toISOString(),z=e=>`preview-state:${e}`,T=()=>typeof window<"u"&&window.localStorage?window.localStorage:null,C=e=>e.type==="question",Ee=e=>{const t=[];return e.forEach((a,u)=>{a.steps.forEach((c,i)=>{t.push({section:a,step:c,sectionIndex:u,stepIndex:i,globalIndex:t.length})})}),t},Oe=(e,t)=>e.length===t.length&&e.every(a=>t.includes(a)),Be=(e,t)=>{if(e.inputRule.type==="single"){const a=e.inputRule.correctOptions[0];return t.length===1&&t[0]===a?1:0}return Oe([...t].sort(),[...e.inputRule.correctOptions].sort())?1:0},D=(e,t,a)=>({steps:e.steps.map((c,i)=>i===t?a(c):c),position:e.position}),ae=e=>({steps:Ee(e.structure),position:0}),R=e=>e.steps[e.position]??null,$=e=>!!e.answer?.submittedAt,je=e=>{const t=R(e);return!t||!C(t.step)||$(t)?!1:(t.answer?.selected??[]).length>0},Le=e=>{const t=R(e);if(!t||!C(t.step)||$(t))return e;const a=t.answer?.selected??[],u=Be(t.step,a),c={selected:[...a],score:u,submittedAt:$e()};return D(e,e.position,i=>({...i,answer:c}))},De=(e,t)=>{const a=R(e);if(!a||!C(a.step)||$(a))return e;const u={selected:[t],score:0,submittedAt:""};return D(e,e.position,c=>({...c,answer:u}))},Ve=(e,t)=>{const a=R(e);if(!a||!C(a.step)||$(a)||a.step.inputRule.type!=="multiple")return e;const c={selected:Array.from(new Set((t??[]).filter(i=>Number.isFinite(i)).map(i=>Number(i)))).sort((i,p)=>i-p),score:0,submittedAt:""};return D(e,e.position,i=>({...i,answer:c}))},ue=e=>e.position>0,ie=e=>{if(e.position>=e.steps.length-1)return!1;const t=R(e);return t?C(t.step)?$(t):!0:!1},Qe=e=>ue(e)?{...e,position:e.position-1}:e,Ge=e=>ie(e)?{...e,position:e.position+1}:e,ze=(e,t)=>{const a=Math.max(0,Math.min(t,e.steps.length-1));return{...e,position:a}},Te=e=>{const t=new Map;e.steps.forEach(p=>{if(t.has(p.section.id)||t.set(p.section.id,{section:p.section,questions:0,correct:0}),C(p.step)){const _=t.get(p.section.id);_.questions+=1,_.correct+=p.answer?.score===1?1:0}});const a=[...t.values()].map(p=>({...p,accuracy:p.questions===0?0:p.correct/p.questions})),u=a.reduce((p,_)=>p+_.questions,0),c=a.reduce((p,_)=>p+_.correct,0),i=u===0?0:c/u;return{totalQuestions:u,totalCorrect:c,totalAccuracy:i,bySection:a}},Ue=(e,t)=>{if(!t)return e;const a=new Map(e.steps.map((c,i)=>[c.step.id,i]));t.answers.forEach(c=>{const i=a.get(c.stepId);if(i==null)return;const p=e.steps[i];if(!p||!C(p.step))return;const _=Array.isArray(c.selected)?c.selected.filter(v=>Number.isFinite(v)).map(v=>Number(v)):[],N={selected:p.step.inputRule.type==="multiple"?Array.from(new Set(_)).sort((v,k)=>v-k):_.slice(0,1),score:Number.isFinite(c.score)?c.score:0,submittedAt:typeof c.submittedAt=="string"?c.submittedAt:""};e=D(e,i,v=>({...v,answer:N}))});const u=Math.max(0,Math.min(t.position??0,e.steps.length-1));return{...e,position:u}},Ke=e=>{const t=ae(e),a=T();if(!a)return t;const u=a.getItem(z(e.id));if(!u)return t;try{const c=JSON.parse(u);return Ue(t,c)}catch{return t}},Je=(e,t)=>{const a=T();if(!a)return;const u=t.steps.filter(i=>C(i.step)&&i.answer).map(i=>({stepId:i.step.id,selected:[...i.answer?.selected??[]],score:i.answer?.score??0,submittedAt:i.answer?.submittedAt??""})),c={position:t.position,answers:u};a.setItem(z(e),JSON.stringify(c))},He=e=>{const t=T();t&&t.removeItem(z(e))},We={class:"flex flex-col bg-white"},Xe={class:"border-b border-gray-200 px-4 py-2 flex items-center justify-between shrink-0"},Ye={class:"text-sm font-medium truncate"},Ze={class:"text-xs text-gray-600 shrink-0 ml-4"},et={class:"flex flex-1 overflow-hidden"},tt={class:"w-60 border-r border-gray-200 overflow-y-auto shrink-0"},st={class:"p-2 space-y-3"},rt={class:"px-2 text-xs font-semibold text-gray-700 flex items-center justify-between"},nt={class:"truncate"},ot={class:"text-[10px] text-gray-500 shrink-0 ml-2"},lt={class:"space-y-0.5"},at=["onClick"],ut={class:"truncate block"},it={class:"pt-3 mt-3 border-t border-gray-100"},ct={class:"flex-1 overflow-y-auto p-6"},dt={key:0,class:"max-w-3xl mx-auto"},pt={class:"border border-gray-200 rounded-lg bg-gray-50 p-5"},vt={class:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"},ft={class:"text-base font-semibold text-gray-900"},bt={class:"text-sm text-gray-600"},gt={class:"text-sm font-semibold text-gray-900"},yt={class:"mt-4 grid gap-3 md:grid-cols-2"},mt={class:"text-sm font-medium text-gray-900"},ht={class:"text-xs text-gray-500"},xt={class:"text-sm font-semibold text-gray-900"},_t={class:"mt-6 flex justify-end"},wt={key:1,class:"max-w-3xl mx-auto"},kt={key:0,class:"space-y-4"},St={key:0,class:"text-lg font-semibold text-gray-900"},Pt={key:1,class:"space-y-4"},Ct={key:0,class:"text-lg font-semibold text-gray-900"},Nt={class:"text-xs font-semibold text-gray-600"},At={class:"mt-4 space-y-2"},It=["disabled","onClick"],qt={class:"flex items-center gap-3"},Mt={class:"text-sm text-gray-900 flex-1"},Ft={key:0,class:"text-green-600 shrink-0","aria-label":"Correct answer"},Rt={key:1,class:"mt-4 flex justify-end"},$t=["disabled"],Et={class:"text-sm font-medium"},Ot={class:"border-t border-gray-200 px-4 py-3 flex items-center justify-between shrink-0 bg-gray-50"},Bt={class:"flex items-center gap-3"},jt=["disabled"],Lt={class:"text-xs text-gray-600"},Dt=["disabled"],Tt=Se({__name:"CoursePreviewPage",setup(e){const t=Ie(),a=Ae(),{t:u}=Pe(),c=Re,i=M(""),p=M(null),_=M([]),r=M(null),N=M(0),v=M(!1),k=()=>{!p.value||!r.value||Je(p.value.id,r.value)},ce=l=>{if(!l)return 0;const d=l.steps.reduce((s,b)=>b.answer?Math.max(s,b.globalIndex):s,-1);return Math.max(0,d,l.position)},o=x(()=>r.value?R(r.value):null),U=x(()=>r.value?.position??0),de=x(()=>r.value?.steps.length??0),pe=x(()=>o.value?.step.type==="slide"),S=x(()=>o.value?$(o.value):!1),K=x(()=>r.value?ue(r.value):!1),J=x(()=>r.value?ie(r.value):!1),H=x(()=>r.value?je(r.value):!1),ve=x(()=>!r.value||r.value.steps.length===0?!1:r.value.position===r.value.steps.length-1),E=x(()=>!r.value||!r.value.steps.some(d=>d.step.type==="question")?!1:r.value.steps.every(d=>d.step.type!=="question"||!!d.answer?.submittedAt)),W=x(()=>E.value&&ve.value&&!v.value),q=x(()=>!E.value||!r.value?null:Te(r.value)),X=x(()=>v.value?u("coursePreview.finalReportLabel"):u("coursePreview.progress",{current:(U.value??0)+1,total:de.value??0})),V=l=>`${Math.round((l??0)*100)}%`;Ce(U,l=>{N.value=Math.max(N.value,l)});const Y=l=>l<=N.value,Z=(l,d)=>r.value?r.value.steps.findIndex(s=>s.section.id===l&&s.stepIndex===d):-1,fe=()=>!o.value||o.value.step.type!=="question"?u("coursePreview.instructionDefault"):o.value.step.inputRule.type==="single"?u("coursePreview.instructionSingle"):u("coursePreview.instructionMultiple"),be=(l,d,s)=>{if(!o.value)return"text-gray-600 hover:bg-gray-50";const b=o.value.section.id===l&&o.value.step.id===d,g=Y(s);return v.value?g?"text-gray-700 hover:bg-gray-50":"text-gray-400 opacity-60 cursor-not-allowed":b?"bg-blue-50 text-blue-700 font-medium":g?"text-gray-700 hover:bg-gray-50":"text-gray-400 opacity-60 cursor-not-allowed"},ge=(l,d)=>{if(!r.value)return;v.value=!1;const s=Z(l,d);s<0||!Y(s)||(r.value=ze(r.value,s),k())},ee=l=>{if(!r.value||!o.value||S.value||o.value.step.type!=="question")return;let d=null;if(o.value.step.inputRule.type==="single")d=De(r.value,l);else{const s=new Set(o.value.answer?.selected??[]);s.has(l)?s.delete(l):s.add(l),d=Ve(r.value,[...s])}d&&(r.value=d,k())},ye=l=>{if(!o.value||o.value.step.type!=="question")return"border-gray-200 hover:border-gray-300";const s=(o.value.answer?.selected??[]).includes(l),b=S.value,g=Q(l);return b?s&&g?"border-green-500 bg-green-50":s&&!g?"border-red-500 bg-red-50":!s&&g?"border-green-200 bg-green-50/30":"border-gray-200 bg-gray-50":s?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"},me=l=>{if(!o.value||o.value.step.type!=="question")return"w-6 h-6 rounded-full border bg-gray-100 text-gray-600 border-transparent";const{step:d}=o.value,b=d.inputRule.type==="multiple"?"w-6 h-6 rounded-md border":"w-6 h-6 rounded-full border",g=(B,G,ke)=>`${b} ${B} ${G} ${ke}`,A=(o.value.answer?.selected??[]).includes(l),h=S.value,I=Q(l);return h?A&&I?g("bg-green-600","text-white","border-green-600"):A&&!I?g("bg-red-600","text-white","border-red-600"):!A&&I?g("bg-green-50","text-green-800","border-green-200"):g("bg-gray-200","text-gray-600","border-gray-200"):A?g("bg-blue-600","text-white","border-blue-600"):g("bg-gray-100","text-gray-600","border-transparent")},Q=l=>!o.value||o.value.step.type!=="question"?!1:o.value.step.inputRule.correctOptions.includes(l),he=()=>o.value?.answer?o.value.answer.score===1?"bg-green-50 text-green-800":"bg-red-50 text-red-800":"bg-gray-100",te=()=>{!r.value||!K.value||(v.value=!1,r.value=Qe(r.value),k())},se=()=>{if(r.value){if(W.value){v.value=!0;return}J.value&&(v.value=!1,r.value=Ge(r.value),k())}},re=()=>{!r.value||!H.value||(v.value=!1,r.value=Le(r.value),k())},xe=()=>{E.value&&(v.value=!0)},_e=()=>E.value?v.value?"px-2 py-1 text-xs rounded bg-blue-50 text-blue-700 font-medium":"px-2 py-1 text-xs rounded text-gray-700 hover:bg-gray-50 cursor-pointer":"px-2 py-1 text-xs rounded text-gray-400 opacity-60 cursor-not-allowed",we=()=>{p.value&&(He(p.value.id),r.value=ae(p.value),N.value=0,v.value=!1,k())},ne=l=>{if(v.value||!o.value)return;if(l.key==="Enter"){l.preventDefault(),!pe.value&&!S.value?re():se();return}if(l.key==="Escape"){l.preventDefault(),te();return}const d=Number(l.key);if(d>=1&&d<=9&&o.value.step.type==="question"){const s=d-1;s<o.value.step.options.length&&ee(s)}};return Ne(async()=>{const l=await Me(c),d=a.params.path||"",s=d.endsWith("/")?`/${d}`:`/${d}/`,g=(h=>{const I=h.split("/").filter(Boolean).map(G=>Number(G)).filter(Number.isFinite),B=I.length>0?I[I.length-1]:void 0;return B??null})(s),P=g!=null?l.find(h=>h.id===g&&h.deletedAt===null):null;if(!P||P.type!=="leaf"){t.push({path:"/"});return}i.value=P.name;const A=typeof P.objectId=="string"?P.objectId:null;if(A){const h=Fe(A);if(h&&h.deletedAt===null)p.value=h,i.value=h.fullName||P.name,_.value=h.structure||[],r.value=Ke(h),N.value=ce(r.value),v.value=E.value,k();else{t.push({path:`/course${s}`});return}}else{t.push({path:`/course${s}`});return}window.addEventListener("keydown",ne)}),qe(()=>{window.removeEventListener("keydown",ne)}),(l,d)=>(m(),y("div",We,[n("header",Xe,[n("h1",Ye,f(i.value),1),n("span",Ze,f(X.value),1)]),n("div",et,[n("aside",tt,[n("nav",st,[(m(!0),y(j,null,L(_.value,s=>(m(),y("div",{key:s.id,class:"space-y-1"},[n("div",rt,[n("span",nt,f(s.name),1),n("span",ot,f(s.steps.length),1)]),n("ul",lt,[(m(!0),y(j,null,L(s.steps,(b,g)=>(m(),y("li",{key:b.id,class:O(["px-2 py-1 text-xs rounded cursor-pointer transition-colors",be(s.id,b.id,Z(s.id,g))]),onClick:P=>ge(s.id,g)},[n("span",ut,f(b.name||w(u)(b.type==="slide"?"coursePreview.slideFallback":"coursePreview.questionFallback")),1)],10,at))),128))])]))),128)),n("div",it,[n("div",{class:O(["transition-colors",_e()]),onClick:xe},f(w(u)("coursePreview.finalReportNav")),3)])])]),n("main",ct,[v.value&&q.value?(m(),y("div",dt,[n("div",pt,[n("div",vt,[n("div",null,[n("h2",ft,f(w(u)("coursePreview.finalReportHeading")),1),n("p",bt,f(w(u)("coursePreview.finalReportSummary",{correct:q.value.totalCorrect,total:q.value.totalQuestions,accuracy:V(q.value.totalAccuracy)})),1)]),n("span",gt,f(V(q.value.totalAccuracy)),1)]),n("div",yt,[(m(!0),y(j,null,L(q.value.bySection,s=>(m(),y("div",{key:s.section.id,class:"rounded-lg border border-gray-200 bg-white p-4 flex items-center justify-between"},[n("div",null,[n("p",mt,f(s.section.name),1),n("p",ht,f(w(u)("coursePreview.sectionCorrectSummary",{correct:s.correct,total:s.questions})),1)]),n("span",xt,f(V(s.accuracy)),1)]))),128))]),n("div",_t,[n("button",{type:"button",class:"px-4 py-2 text-sm font-medium text-blue-600 border border-blue-200 rounded-md hover:bg-blue-50",onClick:we},f(w(u)("coursePreview.tryAgainButton")),1)])])])):o.value?(m(),y("div",wt,[o.value.step.type==="slide"?(m(),y("div",kt,[o.value.step.name?(m(),y("h2",St,f(o.value.step.name),1)):F("",!0),oe(le,{content:o.value.step.content},null,8,["content"])])):(m(),y("div",Pt,[o.value.step.name?(m(),y("h2",Ct,f(o.value.step.name),1)):F("",!0),oe(le,{content:o.value.step.slide},null,8,["content"]),n("p",Nt,f(fe()),1),n("ul",At,[(m(!0),y(j,null,L(o.value.step.options,(s,b)=>(m(),y("li",{key:b},[n("button",{type:"button",class:O(["w-full text-left px-4 py-3 rounded-lg border-2 transition-all",ye(b)]),disabled:S.value,onClick:g=>ee(b)},[n("div",qt,[n("span",{class:O(["inline-flex items-center justify-center text-xs font-semibold shrink-0 transition-colors",me(b)])},f(b+1),3),n("span",Mt,f(s),1),S.value&&Q(b)?(m(),y("span",Ft," âœ“ ")):F("",!0)])],10,It)]))),128))]),S.value?F("",!0):(m(),y("div",Rt,[n("button",{type:"button",class:"px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!H.value,onClick:re},f(w(u)("coursePreview.submitButton")),9,$t)])),S.value?(m(),y("div",{key:2,class:O(["mt-4 p-3 rounded-lg",he()])},[n("span",Et,f(o.value.answer?.score===1?w(u)("coursePreview.feedbackCorrect"):w(u)("coursePreview.feedbackIncorrect")),1)],2)):F("",!0)]))])):F("",!0)])]),n("footer",Ot,[n("div",Bt,[n("button",{type:"button",class:"px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",disabled:!K.value,onClick:te},f(w(u)("coursePreview.backButton")),9,jt),n("span",Lt,f(X.value),1)]),n("div",null,[n("button",{type:"button",class:"px-6 py-2 text-sm font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",disabled:v.value||!J.value&&!W.value,onClick:se},f(w(u)("coursePreview.nextButton")),9,Dt)])])]))}});export{Tt as default};
